---
title: I/O管理与磁盘调度
date: 2023-02-13 21:26:24
author: Thm
tags: Operating System
math: true
katex: true
mermaid: true
---
# I/O管理与磁盘调度

## I/O管理

### I/O设备概述
外设分类: 
1. 按信息传输方向: 
    - 输入设备: 从外部向计算机输入信息，如：键盘、鼠标、扫描仪等
    - 输出设备:从计算机向外部输出信息，如：打印机、显示器等
    - 输入输出设备: 既可输入又可输出，如：带触屏的显示器、磁盘存储器等
2. 按功能: 
    - 人-机交互设备:输入/输出的信息是人可读的，或可操作的。如: 键盘、鼠标、扫描仪、打印机、显示器等
    - 外部存储设备: 用于信息的存储(其输入/出的信息是机器可读的)。如: 磁盘、磁带、光盘等
    - 主机间通信设备: 主要用于计算机和计算机之间的通信。如: 网卡、调制解调器、A/D、D/A等

![外部设备通用模型](io_devices_model.png)
- 电缆: 通过电缆与计算机内部I/O接口进行数据、状态和控制信息的传送。电缆线中包括**控制信号**、**状态信号**和**数据信号**三种信号线
- 控制逻辑: 根据控制信息控制设备的操作并检测设备状态
- 缓冲器: **用于保存与计算机交换的数据信息**
- 变换器: 用于实现电信号形式与其他形式的设备数据之间的转换

<b>所有外部设备均可抽象为该模型</b>

### I/O控制方式
I/O设备与主机进行数据交换的三种基本方式: 
- 程序直接控制方式: 
    - 无条件传送: 对简单外设定时同步进行数据传送
    - **条件传送**: 轮询方式，OS主动查询，I/O设备将自己的状态放到一个状态寄存器中，OS阶段性的查询状态寄存器中的特定状态以决定下一步动作。
- **中断方式**: 几乎所有系统都支持的方式
    1. 当一个I/O设备需要CPU的干预时，他通过**中断请求来通知CPU**
    2. CPU**中止当前程序的执行**，调出OS中断处理程序来执行
    3. 处理完成后**返回到中止的程序继续执行**
- **DMA方式**: 磁盘等高速外设**成批的直接和主存进行数据交换**



<span style="color:#ff562b"><b>三种方式的详细说明在计组的[互连及输入输出组织](https://thm-lab.github.io/2022/06/13/%E4%BA%92%E8%BF%9E%E5%8F%8A%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%BB%84%E7%BB%87/#io%E4%BC%A0%E8%BE%93%E6%96%B9%E5%BC%8F)
</b></span>

**I/O通道控制方式**
**I/O通道**: **是DMA方式的发展**，有自己的I/O指令集，通过**执行通道程序，与设备控制器共同实现对I/O设备的控制**

**与DMA方式的不同**: 
- DMA以**一个数据块**为数据读写单位，I/O通道以**一组数据块**为数据读写单位
- DMA中**CPU控制传输方向、数据大小、数据在内存的位置**，**I/O通道自己控制传输方向、数据大小、数据在内存的位置**

因此I/O通道可实现CPU、I/O通道和I/O设备三者的并行操作，从而更有效地提高整个系统的资源利用率

**一个设备可以连接到多个控制器上，而一个控制器又连接到多个通道上**
![I/O通道](io_channel.png)

![I/O控制发展史](io_control_development.png)

### I/O功能组织模型
操作系统的功能可以根据复杂性、特征时间尺度(time scale)和层次的抽象来分开，每一层执行相关的子功能，**分层定义**，**使得某层的功能变化不影响其他层次**

![I/O功能组织模型](io_organization_model.png)
- **逻辑I/O**: 把设备当作**逻辑资源**处理，不关心控制设备的细节
- **设备I/O**: 请求的操作和数据被转换成对应的I/O指令、通道指令和控制器指令，并可以使用缓冲提高效率，**设备驱动是典型设备I/O层产物**
- **调度和控制**: 与硬件真正发生交互的软件层，处理中断，收集和报告I/O状态

典型I/O功能组织模型的设计结构: 
- 通信架构
- 文件系统

![通信架构](communication.png)
![文件系统](file_system.png)

### I/O缓冲
**缓冲**: 操作系统在**内存中**给I/O请求分配一个**缓冲区**

缓冲的**作用**: 
- **缓解I/O设备速度与CPU速度不匹配的矛盾**，进程的需求大于I/O设备的服务能力时，进程每处理完一块数据后得停下等待
- 在多道程序环境中，当存在多种I/O活动和多种进程活动时，**缓冲可以提高操作系统效率**，提高单个进程的性能

缓冲缓解I/O设备速度与CPU速度不匹配的**原理**: 
- **在输入请求发出前开始输入传送**
- **在输出请求发出后一段时间后才开始执行输出传送**

I/O设备**传输方式**分类: 
![不同传输方式](block_stream.png)
- **面向块的设备**: 以**数据块为传输单位**，采用**DMA**或**I/O通道**方式控制I/O，传送完一块或一组数据才中断
- **面向流的设备**: 以**字节、字或一行为传输单位**，采用**中断驱动**的I/O控制方式，每传送完一个字节、一个字或一行就产生中断

以下均为输入，输出同理
![无缓冲(T: 传输数据到用户内存的时间，C: 计算时间)](no_buffer.png)
**无缓冲时**，应用程序直接访问I/O设备，**需要等设备将数据传送到内存，再计算**，每块数据处理时间为: **T + C**

![单缓冲(T: 传输数据到系统缓存时间，M: Move数据从内存缓冲区到用户内存的时间，C: 计算时间)](single_buffer.png)
**单缓冲时**，应用程序从缓冲区拿数据，**计算数据时，下一块数据正在传送到缓冲区，因此影响处理时间的为计算时间和传送时间中较大的那个，取走数据后才能将数据输入到缓冲区，因此要加上取数据时间**，每块数据处理时间为: **Max(T, C) + M**

![双缓冲(T: 传输数据到用户内存的时间，C: 计算时间)](double_buffer.png)
**双缓冲时**，应用程序从缓冲区拿数据，**在应用程序从一个缓冲区取数据时，另一个缓冲区可以开始传送新数据，因此影响处理时间的为计算时间和传送时间中较大的那个**，每块数据处理时间为: **Max(T, M + C)**

**循环缓冲**: **使用两个或多个缓冲区构成循环缓冲**，当希望I/O操作跟上进程执行速度时，使用循环缓冲，原理与双缓冲相同
![循环缓冲](circle_buffer.png)

### SPOOLing
**SPOOLing(Simultaneous Peripheral Operating On Line, 假脱机操作)技术**: 在**磁盘中建立I/O缓冲区(上一节为内存缓冲)**，缓和CPU的高速性与I/O设备低速性间的矛盾
同时**通过SPOOLing技术便可将一台独占物理I/O设备虚拟为多台逻辑I/O设备**，从而允许多个用户**共享一台物理I/O设备**

SPOOL结构: 
- 输入/输出进程: **应用程序**，需求使用I/O设备进行输入/输出
- 输入井/输出井: **磁盘上的一块空间**
- 输入缓冲区/输出缓冲区: **内存中一块空间**

SPOOLing**思想**: 
- **输入**: 
  1. 将用户需要数据通过**输入设备送到输入缓冲区**
  2. 将输入缓冲区内的**数据送到输入井**
  3. 当CPU需要数据时，将**数据从输入井送到内存中(不是输入缓冲区，是应用程序自己的内存)**
- **输出**: 
  1. 将用户需要输出的**数据送到输出井中**
  2. 当输出设备空闲时，将**输出井数据送到输出缓冲区中**
  3. 将**输出缓冲区数据输出到输出设备中**

SPOOLing技术**分析**: 
- 通过SPOOLing技术，对应用程序而言，**与I/O设备直接打交道的的低速**提升到了**与磁盘打交道的相对高速**来
- 同时，**没有为任何进程实际分配设备**，只是在输入井/输出井中为进程分配一个存储区和建立一张I/O请求表，因此**将独占设备改造为共享设备**
- 在输入井/输出井中可以进行排队，**一台独占物理设备变换为若干台逻辑设备**，因此**实现了虚拟设备功能**

## 磁盘调度

### 磁盘结构

### 磁盘性能参数

### 磁盘调度

### RAID

### 磁盘cache